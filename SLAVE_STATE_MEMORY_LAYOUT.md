## ä»ç«™çŠ¶æ€è¯»å– - å†…å­˜ç»“æ„å¯è§†åŒ–

### ğŸ“¦ SOEM ä¸Šä¸‹æ–‡ä¸­çš„æ•°æ®å¸ƒå±€

```
soem_context_ (ecx_contextt)
â”‚
â”œâ”€â”€ slavecount = 1  â† æ‰«æåˆ°çš„ä»ç«™æ€»æ•°
â”‚
â”œâ”€â”€ slavelist[0]  â† ä¸»ç«™ï¼ˆé€šå¸¸ä¸ä½¿ç”¨ï¼‰
â”‚   â”œâ”€â”€ state = 0x????
â”‚   â””â”€â”€ name = ""
â”‚
â”œâ”€â”€ slavelist[1]  â† âœ“ æˆ‘ä»¬è¦è¯»å–çš„ï¼šä»ç«™ 1
â”‚   â”œâ”€â”€ state = 0x0002  â† uint16 (2 å­—èŠ‚)
â”‚   â”œâ”€â”€ ALstatuscode = 0x0000
â”‚   â”œâ”€â”€ configadr = 0x0001
â”‚   â”œâ”€â”€ eep_man = 0x000000A1  (åˆ¶é€ å•† ID)
â”‚   â”œâ”€â”€ eep_id = 0xA0000001   (äº§å“ç¼–å·)
â”‚   â”œâ”€â”€ eep_rev = 0x00010001
â”‚   â”œâ”€â”€ name[33] = "Sine Drive\0"
â”‚   â”œâ”€â”€ SM[0].StartAddr = 4096
â”‚   â”œâ”€â”€ SM[0].SMlength = 128
â”‚   â”œâ”€â”€ SM[0].SMflags = 0x10026
â”‚   â”œâ”€â”€ SM[1].StartAddr = 4224
â”‚   â”œâ”€â”€ SM[1].SMlength = 128
â”‚   â”œâ”€â”€ SM[1].SMflags = 0x10022
â”‚   â”œâ”€â”€ SM[2].StartAddr = 4352
â”‚   â”œâ”€â”€ SM[2].SMlength = 8
â”‚   â”œâ”€â”€ SM[2].SMflags = 0x10064
â”‚   â”œâ”€â”€ SM[3].StartAddr = 5120
â”‚   â”œâ”€â”€ SM[3].SMlength = 8
â”‚   â”œâ”€â”€ SM[3].SMflags = 0x10020
â”‚   â””â”€â”€ ... (å…¶ä»– 80+ å­—æ®µ)
â”‚
â”œâ”€â”€ slavelist[2..127]  â† æœªä½¿ç”¨ï¼ˆç½‘ç»œä¸­æ²¡æœ‰è¿™äº›ä»ç«™ï¼‰
â”‚
â””â”€â”€ grouplist[]  â† ä»ç«™åˆ†ç»„ä¿¡æ¯
```

### ğŸ” read_slave_state(1) æ‰§è¡Œè¿‡ç¨‹

```
C++ è°ƒç”¨ï¼š
    uint16 state = lifter.read_slave_state(1);
                                            â†“
                                      ä»ç«™ç¼–å·
                                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lifter::read_slave_state(uint16 slave)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚ 1ï¸âƒ£  æ£€æŸ¥åˆå§‹åŒ–                                              â”‚
â”‚    if (!soem_initialized_) return 0;  âœ“ é€šè¿‡              â”‚
â”‚                                                            â”‚
â”‚ 2ï¸âƒ£  æ£€æŸ¥ä»ç«™å·èŒƒå›´                                          â”‚
â”‚    if (slave < 1 || slave > slavecount) return 0;         â”‚
â”‚    if (1 < 1 || 1 > 1) return 0;  âœ“ é€šè¿‡                  â”‚
â”‚                                                            â”‚
â”‚ 3ï¸âƒ£  è¯»å–çŠ¶æ€ (ä»å†…å­˜ç›´æ¥è¯»å–)                               â”‚
â”‚    uint16 state = soem_context_.slavelist[1].state;       â”‚
â”‚                                   â†“                       â”‚
â”‚    å†…å­˜åœ°å€ = &soem_context_ + offset(slavelist[1].state) â”‚
â”‚    è¯»å– 16 ä½ = 0x0002                                    â”‚
â”‚                                                            â”‚
â”‚ 4ï¸âƒ£  æ‰“å°æ—¥å¿—                                               â”‚
â”‚    "Slave 1 (Sine Drive) current state: 0x0002"           â”‚
â”‚                                                            â”‚
â”‚ 5ï¸âƒ£  è¿”å›çŠ¶æ€å€¼                                             â”‚
â”‚    return 0x0002;  â† ç”±è°ƒç”¨è€…æ¥æ”¶                          â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
            uint16 state = 0x0002 (PREOP)
```

### â° çŠ¶æ€å€¼ä½•æ—¶æ›´æ–°ï¼Ÿ

```
æ—¶é—´çº¿ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

åˆå§‹åŒ–é˜¶æ®µï¼š
  0ms    ecx_init()
         â†’ ç½‘ç»œæ¥å£åˆå§‹åŒ–
         â†’ slavelist[].state ä»æœªè®¾ç½®

  10ms   ecx_config_init()
         â†’ SOEM æ‰«æç½‘ç»œ
         â†’ å‘ç°ä»ç«™ 1
         â†’ å‘½ä»¤çŠ¶æ€è½¬æ¢: INIT â†’ PREOP
         â†’ slavelist[1].state = 0x0002 âœ“

  50ms   ecx_statecheck(..., EC_STATE_SAFE_OP)
         â†’ å‘é€ PREOP â†’ SAFEOP å‘½ä»¤
         â†’ slavelist[1].state = 0x0004 âœ“

è¿è¡Œé˜¶æ®µï¼ˆå®šæ—¶å¾ªç¯ï¼‰ï¼š
  60ms   timer_callback():
         ecx_send_processdata();
         ecx_receive_processdata();
         â†“
         (SOEM è‡ªåŠ¨æ›´æ–°æ‰€æœ‰ slavelist[].state)
         å¦‚æœä»ç«™æ‰çº¿ï¼Œslavelist[1].state å¯èƒ½å˜ä¸º 0x0010 (ERROR)

  70ms   å®šæ—¶å¾ªç¯...

  80ms   å®šæ—¶å¾ªç¯...

ç”¨æˆ·è°ƒç”¨ read_slave_state(1) æ—¶ï¼š
  75ms   state = read_slave_state(1);
         â†’ è¿”å›æœ€è¿‘ä¸€æ¬¡è½®è¯¢è·å¾—çš„ state
         â†’ é€šå¸¸ state å·²æ˜¯æœ€æ–°å€¼ï¼ˆå»¶è¿Ÿ < 10msï¼‰
```

### ğŸ”— ä»ç«™çŠ¶æ€ä¸ ALstatuscode çš„å…³ç³»

```
ä»ç«™å‘ç”Ÿæ•…éšœæ—¶çš„å…¸å‹æµç¨‹ï¼š

slavelist[1].state = 0x0004 (SAFEOP) âœ“ æ­£å¸¸
slavelist[1].ALstatuscode = 0x0000   âœ“ æ— é”™è¯¯

       â†“ (ä»ç«™å†…éƒ¨å‘ç”Ÿæ•…éšœ)

slavelist[1].state = 0x0010 (ERROR)  âš ï¸ çŠ¶æ€å˜ä¸ºé”™è¯¯
slavelist[1].ALstatuscode = 0x0021   âš ï¸ é”™è¯¯ä»£ç ï¼šInvalid input configuration

     â†“ (ç”¨æˆ·å¯é€šè¿‡éªŒè¯æ£€æµ‹åˆ°)

bool ok = verify_slave_state(1, EC_STATE_OPERATIONAL);
// è¿”å› falseï¼Œå¹¶æ‰“å°:
// "Slave 1 state verification FAILED: expected 0x0008, got 0x0010"
// åŒæ—¶æŠ¥å‘Š ALstatuscode: 0x0021
```

### ğŸ’¾ C è¯­è¨€åº•å±‚å®ç°ï¼ˆSOEM æ ¸å¿ƒä»£ç ï¼‰

```c
/* åœ¨ SOEM çš„è½®è¯¢çº¿ç¨‹ä¸­ */
void ecx_receive_processdata_frame(ecx_contextt *context, ...) {
    // å¯¹æ¯ä¸ªä»ç«™
    for (slave = 1; slave <= context->slavecount; slave++) {
        // è¯»å–çŠ¶æ€å¯„å­˜å™¨ (0x130 åœ°å€)
        uint16 state = ec_read_uint16(slave_address, 0x130);
        
        // æ›´æ–°ç¼“å­˜
        context->slavelist[slave].state = state;
        
        // è¯»å–é”™è¯¯çŠ¶æ€ä»£ç  (0x130 åç§» +2)
        uint16 alstatuscode = ec_read_uint16(slave_address, 0x132);
        context->slavelist[slave].ALstatuscode = alstatuscode;
        
        // æ›´æ–°å…¶ä»–å­—æ®µ...
    }
}

/* C++ ä¸­çš„è°ƒç”¨ */
uint16 state = soem_context_.slavelist[1].state;
// â†‘ è¿™åªæ˜¯è¯»å–å·²ç¼“å­˜çš„å€¼ï¼Œä¸æ¶‰åŠç½‘ç»œé€šä¿¡
```

### ğŸ¯ è¯»å–çŠ¶æ€çš„ä¸‰ç§æ–¹å¼å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹å¼                â”‚ å®ç°                â”‚ ç‰¹ç‚¹             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¼“å­˜è¯»å–            â”‚ uint16 state =      â”‚ âœ“ å¿«é€Ÿ (< 1Î¼s)   â”‚
â”‚ (æˆ‘ä»¬çš„æ–¹æ³•)        â”‚   slavelist[].state â”‚ âœ“ æ— é˜»å¡         â”‚
â”‚                     â”‚                     â”‚ âš ï¸ å»¶è¿Ÿ ~10ms   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç›´æ¥è¯»å–            â”‚ ecx_SDOread(...)   â”‚ âœ“ å®æ—¶è¯»å–       â”‚
â”‚ (CoE SDO)           â”‚ å¯¹è±¡ 0x5130         â”‚ âœ— æ…¢ (10-100ms) â”‚
â”‚                     â”‚                     â”‚ âœ— é˜»å¡çº¿ç¨‹       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¼ºåˆ¶æ£€æŸ¥            â”‚ ecx_statecheck(...) â”‚ âœ“ å¼ºåˆ¶è½¬æ¢çŠ¶æ€  â”‚
â”‚ (çŠ¶æ€è½¬æ¢)          â”‚ + è½®è¯¢ slavelist    â”‚ âœ— éå¸¸æ…¢        â”‚
â”‚                     â”‚                     â”‚ âœ— å¯èƒ½å¤±è´¥      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“Š å®Œæ•´çš„ä»ç«™çŠ¶æ€æœº

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚     INIT       â”‚ (0x0001)
                        â”‚   åˆå§‹åŒ–ä¸­      â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ (ecx_config_init è‡ªåŠ¨è½¬æ¢)
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚     PREOP      â”‚ (0x0002)
                        â”‚    é…ç½®å·²å®Œæˆ   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ (ecx_statecheck æˆ–ç”¨æˆ·è¯·æ±‚)
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚     SAFEOP     â”‚ (0x0004)
                        â”‚    åŒæ­¥å·²å®Œæˆ   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ (ecx_statecheck æˆ–ç”¨æˆ·è¯·æ±‚)
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚      OP        â”‚ (0x0008)
                        â”‚    è¿è¡Œä¸­       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ (æ•…éšœæˆ–æ–­çº¿)
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚     ERROR      â”‚ (0x0010)
                        â”‚    æ•…éšœ        â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ› ï¸ è°ƒè¯•æŠ€å·§

```bash
# å®æ—¶ç›‘æµ‹ä»ç«™çŠ¶æ€
while true; do
  timeout 1 /path/to/lifter_node 2>&1 | grep "state:"
  sleep 1
done

# æŸ¥çœ‹ ALstatuscode å«ä¹‰
# å¸¸è§é”™è¯¯ç ï¼š
# 0x0000 = OK, no error
# 0x0021 = Invalid input configuration
# 0x0022 = Invalid output configuration
# 0x0023 = Watchdog timed out
# 0x0024 = Sync error
# è¯¦è§ EtherCAT æ ‡å‡† Part 5
```
